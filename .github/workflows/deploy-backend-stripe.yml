# ä¸“é—¨ç”¨äºStripeæ”¯ä»˜ç³»ç»Ÿçš„åç«¯éƒ¨ç½²

name: Deploy Backend with Stripe Support

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend-stripe.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Backend with Stripe
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Prepare Backend
        run: |
          echo "ğŸ”§ Preparing backend for deployment..."
          cd backend
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶
          echo "ğŸ“‹ Checking required files..."
          ls -la
          
          # ç¡®ä¿æœ‰æ­£ç¡®çš„package.json
          if [ ! -f "package.json" ]; then
            if [ -f "workers-package.json" ]; then
              echo "ğŸ“¦ Using workers-package.json as package.json"
              cp workers-package.json package.json
            else
              echo "âŒ No package.json found!"
              exit 1
            fi
          fi
          
          # æ˜¾ç¤ºpackage.jsonå†…å®¹
          echo "ğŸ“„ Package.json content:"
          cat package.json
          
          # æ£€æŸ¥wrangler.toml
          echo "ğŸ“„ Wrangler.toml content:"
          cat wrangler.toml

      - name: Install Dependencies
        run: |
          cd backend
          echo "ğŸ“¦ Installing dependencies..."
          npm install
          echo "âœ… Dependencies installed"
          
          # éªŒè¯wranglerå®‰è£…
          npx wrangler --version

      - name: Validate Configuration
        run: |
          cd backend
          echo "ğŸ” Validating configuration..."
          
          # æ£€æŸ¥TypeScriptæ–‡ä»¶
          if [ -f "worker.ts" ]; then
            echo "âœ… worker.ts found"
            echo "ğŸ“Š Checking for Stripe integration..."
            grep -q "CloudflareStripeService" worker.ts && echo "âœ… Stripe service found" || echo "âš ï¸ Stripe service not found"
            grep -q "STRIPE_SECRET_KEY" worker.ts && echo "âœ… Stripe env vars found" || echo "âš ï¸ Stripe env vars not found"
          else
            echo "âŒ worker.ts not found!"
            exit 1
          fi

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'backend'
          command: deploy --compatibility-date=2024-08-01

      - name: Post-Deploy Verification
        run: |
          echo "ğŸ§ª Post-deployment verification..."
          sleep 15  # ç­‰å¾…éƒ¨ç½²å®Œå…¨ç”Ÿæ•ˆ
          
          # åŸºç¡€å¥åº·æ£€æŸ¥
          echo "ğŸ“Š Testing health endpoint..."
          HEALTH_RESPONSE=$(curl -s -w "%{http_code}" https://destiny-backend.rocky-liang.workers.dev/api/health)
          echo "Health response: $HEALTH_RESPONSE"
          
          # æ£€æŸ¥Stripeç›¸å…³ç«¯ç‚¹æ˜¯å¦å­˜åœ¨ï¼ˆä¸éœ€è¦è®¤è¯çš„æ£€æŸ¥ï¼‰
          echo "ğŸ“Š Testing Stripe webhook endpoint availability..."
          WEBHOOK_RESPONSE=$(curl -s -w "%{http_code}" -X POST https://destiny-backend.rocky-liang.workers.dev/api/stripe/webhook)
          echo "Webhook response: $WEBHOOK_RESPONSE"
          
          echo "âœ… Deployment verification completed!"

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment Summary:"
          echo "âœ… Backend deployed to: https://destiny-backend.rocky-liang.workers.dev"
          echo "âœ… Health check: /api/health"
          echo "âœ… Stripe endpoints available:"
          echo "   - POST /api/stripe/create-payment"
          echo "   - POST /api/stripe/webhook"
          echo "   - GET /api/stripe/subscription-status"
          echo "   - POST /api/stripe/cancel-subscription"
          echo ""
          echo "ğŸ”§ Next steps:"
          echo "1. Verify Stripe secrets are configured: wrangler secret list"
          echo "2. Test payment flow with frontend"
          echo "3. Configure Stripe webhook in dashboard"
          echo "4. Monitor logs: wrangler tail"
