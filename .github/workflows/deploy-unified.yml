# ç»Ÿä¸€çš„éƒ¨ç½²å·¥ä½œæµ - æ›¿ä»£æ‰€æœ‰é‡å¤çš„å·¥ä½œæµ
name: Deploy to Cloudflare

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Choose deployment target'
        required: true
        default: 'both'
        type: choice
        options:
          - 'both'
          - 'frontend'
          - 'backend'
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

jobs:
  # æ£€æµ‹å˜æ›´çš„æ–‡ä»¶
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      backend-changed: ${{ steps.changes.outputs.backend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘æ—¶æ ¹æ®è¾“å…¥å†³å®š
            if [ "${{ github.event.inputs.deploy_target }}" = "frontend" ] || [ "${{ github.event.inputs.deploy_target }}" = "both" ]; then
              echo "frontend=true" >> $GITHUB_OUTPUT
            else
              echo "frontend=false" >> $GITHUB_OUTPUT
            fi
            
            if [ "${{ github.event.inputs.deploy_target }}" = "backend" ] || [ "${{ github.event.inputs.deploy_target }}" = "both" ]; then
              echo "backend=true" >> $GITHUB_OUTPUT
            else
              echo "backend=false" >> $GITHUB_OUTPUT
            fi
          else
            # è‡ªåŠ¨è§¦å‘æ—¶æ£€æµ‹æ–‡ä»¶å˜æ›´
            if git diff --name-only HEAD~1 HEAD | grep -E '^(src/|public/|index\.html|package\.json|vite\.config\.ts|tsconfig\.json|\.env)'; then
              echo "frontend=true" >> $GITHUB_OUTPUT
            else
              echo "frontend=false" >> $GITHUB_OUTPUT
            fi
            
            if git diff --name-only HEAD~1 HEAD | grep -E '^(backend/|\.github/workflows/)'; then
              echo "backend=true" >> $GITHUB_OUTPUT
            else
              echo "backend=false" >> $GITHUB_OUTPUT
            fi
          fi

  # éƒ¨ç½²å‰ç«¯åˆ°Cloudflare Pages
  deploy-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend-changed == 'true'
    runs-on: ubuntu-latest
    name: Deploy Frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Build Frontend
        run: |
          echo "ğŸ”§ Building frontend with production settings..."
          npm run build
          
          echo "ğŸ“‹ Build output:"
          ls -la dist/

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=destiny-frontend

      - name: Frontend Deployment Success
        run: |
          echo "ğŸ‰ Frontend deployed successfully!"
          echo "ğŸ”— URL: https://destiny-frontend.pages.dev"

  # éƒ¨ç½²åç«¯åˆ°Cloudflare Workers
  deploy-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend-changed == 'true'
    runs-on: ubuntu-latest
    name: Deploy Backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Prepare Backend
        run: |
          echo "ğŸ”§ Preparing backend for deployment..."
          cd backend
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶
          echo "ğŸ“‹ Checking required files..."
          ls -la
          
          # ç¡®ä¿æœ‰æ­£ç¡®çš„package.json
          if [ ! -f "package.json" ]; then
            if [ -f "workers-package.json" ]; then
              echo "ğŸ“¦ Using workers-package.json as package.json"
              cp workers-package.json package.json
            else
              echo "âŒ No package.json found!"
              exit 1
            fi
          fi
          
          echo "ğŸ“„ Package.json content:"
          cat package.json

      - name: Install Dependencies
        run: |
          cd backend
          echo "ğŸ“¦ Installing dependencies..."
          rm -rf node_modules package-lock.json || true
          npm install
          echo "âœ… Dependencies installed"

      - name: Validate Configuration
        run: |
          cd backend
          echo "ğŸ” Validating configuration..."
          
          # æ£€æŸ¥TypeScriptæ–‡ä»¶
          if [ -f "worker.ts" ]; then
            echo "âœ… worker.ts found"
            echo "ğŸ“Š Checking for Stripe integration..."
            grep -q "StripeAPIClient" worker.ts && echo "âœ… Stripe API client found" || echo "âš ï¸ Stripe API client not found"
            grep -q "CloudflareStripeService" worker.ts && echo "âœ… Stripe service found" || echo "âš ï¸ Stripe service not found"
          else
            echo "âŒ worker.ts not found!"
            exit 1
          fi

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'backend'
          command: deploy --compatibility-date=2024-08-01 --minify=false --keep-vars

      - name: Post-Deploy Verification
        run: |
          echo "ğŸ§ª Post-deployment verification..."
          sleep 20
          
          # åŸºç¡€å¥åº·æ£€æŸ¥
          echo "ğŸ“Š Testing health endpoint..."
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://destiny-backend.rocky-liang.workers.dev/api/health)
          echo "Health response code: $HEALTH_RESPONSE"
          
          if [ "$HEALTH_RESPONSE" = "200" ]; then
            echo "âœ… Health check passed"
          else
            echo "âš ï¸ Health check returned: $HEALTH_RESPONSE"
          fi
          
          # æ£€æŸ¥Stripeå¥åº·ç«¯ç‚¹
          echo "ğŸ“Š Testing Stripe health endpoint..."
          STRIPE_HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://destiny-backend.rocky-liang.workers.dev/api/stripe/health)
          echo "Stripe health response code: $STRIPE_HEALTH_RESPONSE"
          
          if [ "$STRIPE_HEALTH_RESPONSE" = "200" ]; then
            echo "âœ… Stripe health check passed"
          else
            echo "âš ï¸ Stripe health check returned: $STRIPE_HEALTH_RESPONSE"
          fi

      - name: Backend Deployment Success
        run: |
          echo "ğŸ‰ Backend deployed successfully!"
          echo "ğŸ”— Backend URL: https://destiny-backend.rocky-liang.workers.dev"
          echo "ğŸ”— Health Check: https://destiny-backend.rocky-liang.workers.dev/api/health"
          echo "ğŸ”— Stripe Health: https://destiny-backend.rocky-liang.workers.dev/api/stripe/health"

  # éƒ¨ç½²åçš„é›†æˆæµ‹è¯•
  integration-test:
    needs: [deploy-frontend, deploy-backend]
    if: always() && (needs.deploy-frontend.result == 'success' || needs.deploy-backend.result == 'success')
    runs-on: ubuntu-latest
    name: Integration Test
    steps:
      - name: Wait for deployment propagation
        run: sleep 30

      - name: Test Frontend-Backend Integration
        run: |
          echo "ğŸ§ª Testing frontend-backend integration..."
          
          # æµ‹è¯•å‰ç«¯æ˜¯å¦å¯è®¿é—®
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://destiny-frontend.pages.dev)
          echo "Frontend status: $FRONTEND_STATUS"
          
          # æµ‹è¯•åç«¯API
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://destiny-backend.rocky-liang.workers.dev/api/health)
          echo "Backend status: $BACKEND_STATUS"
          
          # æµ‹è¯•Stripeé›†æˆ
          STRIPE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://destiny-backend.rocky-liang.workers.dev/api/stripe/health)
          echo "Stripe integration status: $STRIPE_STATUS"
          
          if [ "$FRONTEND_STATUS" = "200" ] && [ "$BACKEND_STATUS" = "200" ]; then
            echo "âœ… Integration test passed"
          else
            echo "âš ï¸ Some services may need time to propagate"
          fi

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment Summary:"
          echo "âœ… Frontend: https://destiny-frontend.pages.dev"
          echo "âœ… Backend: https://destiny-backend.rocky-liang.workers.dev"
          echo "âœ… API Health: https://destiny-backend.rocky-liang.workers.dev/api/health"
          echo "âœ… Stripe Health: https://destiny-backend.rocky-liang.workers.dev/api/stripe/health"
          echo ""
          echo "ğŸ”§ Next steps to fix Stripe payment:"
          echo "1. Set real Stripe secrets:"
          echo "   wrangler secret put STRIPE_SECRET_KEY"
          echo "   wrangler secret put STRIPE_WEBHOOK_SECRET"
          echo "2. Update frontend .env with real VITE_STRIPE_PUBLISHABLE_KEY"
          echo "3. Configure Stripe webhook in dashboard"
          echo "4. Test payment flow"
