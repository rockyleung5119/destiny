# .github/workflows/deploy-backend.yml

name: Deploy Backend to Cloudflare Workers

on:
  # å½“ä»£ç è¢«æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'backend/**' # ä»…å½“ backend ç›®å½•ä¸‹çš„æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶æ‰è§¦å‘
      - '.github/workflows/deploy-backend.yml' # å·¥ä½œæµæ–‡ä»¶æœ¬èº«å˜åŒ–ä¹Ÿè§¦å‘

  # å…è®¸æ‚¨åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°çš„ Ubuntu è¿è¡Œç¯å¢ƒ
    name: Deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4 # ç¬¬ä¸€æ­¥ï¼šæ‹‰å–ä»£ç 

      - name: Setup Node.js
        uses: actions/setup-node@v4 # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Node.js ç¯å¢ƒ
        with:
          node-version: '20' # ä½¿ç”¨ Node.js 20 ç‰ˆæœ¬

      - name: Install Dependencies
        run: npm install # ç¬¬ä¸‰æ­¥ï¼šå®‰è£… npm ä¾èµ–
        working-directory: ./backend # æŒ‡å®šåœ¨ backend ç›®å½•ä¸‹æ‰§è¡Œ

      - name: Verify Configuration
        run: |
          echo "ğŸ” Verifying wrangler configuration..."
          npx wrangler --version
          echo "ğŸ“‹ Configuration file content:"
          cat wrangler.toml
        working-directory: ./backend

      # ç§»é™¤æ•°æ®åº“è¿ç§»æ­¥éª¤ï¼Œæ”¹ä¸ºæ‰‹åŠ¨æ‰§è¡Œ
      # æ•°æ®åº“è¿ç§»è¯·ä½¿ç”¨: wrangler d1 execute destiny-db --file=./d1-schema.sql --remote

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'backend'
          # ä½¿ç”¨å®Œæ•´é…ç½®æ–‡ä»¶éƒ¨ç½²ï¼ˆåŒ…å«Durable Objectså’ŒQueuesï¼‰
          command: deploy

      - name: Verify Deployment
        run: |
          echo "ğŸ§ª Verifying deployment..."
          sleep 10  # ç­‰å¾…éƒ¨ç½²å®Œå…¨ç”Ÿæ•ˆ

          # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
          echo "ğŸ“Š Testing health endpoint..."
          curl -f https://destiny-backend.jerryliang5119.workers.dev/api/health || exit 1

          # æµ‹è¯•å¼‚æ­¥çŠ¶æ€ç«¯ç‚¹
          echo "ğŸ“Š Testing async status endpoint..."
          curl -f https://destiny-backend.jerryliang5119.workers.dev/api/async-status || exit 1

          echo "âœ… Deployment verification completed successfully!"
