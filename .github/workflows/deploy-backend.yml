# .github/workflows/deploy-backend.yml

name: Deploy Backend to Cloudflare Workers

on:
  # å½“ä»£ç è¢«æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
    # æš‚æ—¶ç§»é™¤è·¯å¾„è¿‡æ»¤ï¼Œç¡®ä¿å·¥ä½œæµèƒ½è¢«è§¦å‘
    # paths:
    #   - 'backend/**'
    #   - '.github/workflows/deploy-backend.yml'

  # å…è®¸æ‚¨åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°çš„ Ubuntu è¿è¡Œç¯å¢ƒ
    name: Deploy Backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4 # ç¬¬ä¸€æ­¥ï¼šæ‹‰å–ä»£ç 

      - name: Setup Node.js
        uses: actions/setup-node@v4 # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Node.js ç¯å¢ƒ
        with:
          node-version: '20' # ä½¿ç”¨ Node.js 20 ç‰ˆæœ¬
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: Prepare Backend
        run: |
          echo "ğŸ”§ Preparing backend for deployment..."
          cd backend
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶
          echo "ğŸ“‹ Checking required files..."
          ls -la
          
          # ç¡®ä¿æœ‰æ­£ç¡®çš„package.json
          if [ ! -f "package.json" ]; then
            if [ -f "workers-package.json" ]; then
              echo "ğŸ“¦ Using workers-package.json as package.json"
              cp workers-package.json package.json
            else
              echo "âŒ No package.json found!"
              exit 1
            fi
          fi
          
          echo "ğŸ“„ Package.json content:"
          cat package.json

      - name: Install Dependencies
        run: |
          cd backend
          echo "ğŸ“¦ Installing dependencies..."

          # æ£€æŸ¥å½“å‰Nodeç‰ˆæœ¬
          node --version
          npm --version

          # æ¸…ç†å¯èƒ½çš„ç¼“å­˜é—®é¢˜
          rm -rf node_modules package-lock.json || true

          # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„package.json
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found!"
            exit 1
          fi

          # å®‰è£…ä¾èµ–ï¼Œä½¿ç”¨æ›´ç¨³å®šçš„æ–¹å¼
          echo "Installing with npm install..."
          npm install --no-optional --no-audit

          echo "âœ… Dependencies installed"
          echo "ğŸ“Š Installed packages:"
          npm list --depth=0 || echo "Package list may have warnings, continuing..."

      - name: Validate Configuration
        run: |
          cd backend
          echo "ğŸ” Validating configuration..."
          
          # æ£€æŸ¥TypeScriptæ–‡ä»¶
          if [ -f "worker.ts" ]; then
            echo "âœ… worker.ts found"
            echo "ğŸ“Š Checking for Stripe integration..."
            grep -q "StripeAPIClient" worker.ts && echo "âœ… Stripe API client found" || echo "âš ï¸ Stripe API client not found"
            grep -q "CloudflareStripeService" worker.ts && echo "âœ… Stripe service found" || echo "âš ï¸ Stripe service not found"
          else
            echo "âŒ worker.ts not found!"
            exit 1
          fi

      - name: Pre-deployment Resource Check
        run: |
          cd backend
          echo "ğŸ” Checking Cloudflare resources before deployment..."

          # æ£€æŸ¥è®¤è¯çŠ¶æ€
          echo "ğŸ” Checking authentication..."
          wrangler whoami || echo "âš ï¸ Auth check failed, but continuing..."

          # æ£€æŸ¥é˜Ÿåˆ—
          echo "ğŸ“‹ Checking queues..."
          wrangler queues list || echo "âš ï¸ Queue check failed, but continuing..."

          # æ£€æŸ¥D1æ•°æ®åº“
          echo "ğŸ—„ï¸ Checking D1 database..."
          wrangler d1 list || echo "âš ï¸ D1 check failed, but continuing..."

          # æ£€æŸ¥R2å­˜å‚¨æ¡¶
          echo "ğŸ“¦ Checking R2 buckets..."
          wrangler r2 bucket list || echo "âš ï¸ R2 check failed, but continuing..."

          # æ£€æŸ¥worker.tsæ–‡ä»¶å¤§å°
          echo "ğŸ“Š Checking worker.ts file size..."
          WORKER_SIZE=$(wc -c < worker.ts)
          echo "Worker file size: $WORKER_SIZE bytes"
          if [ $WORKER_SIZE -gt 1000000 ]; then
            echo "âš ï¸ Large worker file detected, using optimized deployment"
          fi

          # å¹²è¿è¡Œæµ‹è¯• - ä½¿ç”¨æ ‡å‡†é…ç½®ï¼ˆä¹‹å‰å·¥ä½œæ­£å¸¸ï¼‰
          echo "ğŸ§ª Testing deployment configuration..."
          wrangler deploy --dry-run
          echo "âœ… Pre-deployment checks completed"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Deploy to Cloudflare Workers (Primary)
        id: deploy-main
        uses: cloudflare/wrangler-action@v3
        timeout-minutes: 15
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'backend'
          # ä½¿ç”¨æ ‡å‡†é…ç½®ï¼ˆä¹‹å‰å·¥ä½œæ­£å¸¸ï¼‰ï¼Œä¼˜åŒ–å¤§æ–‡ä»¶éƒ¨ç½²
          command: deploy --compatibility-date=2024-08-01 --no-bundle --minify=false --keep-vars

      - name: Deploy to Cloudflare Workers (Fallback)
        id: deploy-fallback
        if: steps.deploy-main.outcome == 'failure'
        uses: cloudflare/wrangler-action@v3
        timeout-minutes: 15
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'backend'
          # å¤‡ç”¨éƒ¨ç½²ï¼šä½¿ç”¨æ ‡å‡†é…ç½®ï¼Œå¯ç”¨å‹ç¼©
          command: deploy --compatibility-date=2024-08-01

      - name: Deployment Status Check
        if: always()
        run: |
          cd backend
          echo "ğŸ“Š æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."

          if [ "${{ steps.deploy-main.outcome }}" = "success" ] || [ "${{ steps.deploy-fallback.outcome }}" = "success" ]; then
            echo "âœ… åç«¯éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ”— Backend URL: https://destiny-backend.jerryliang5119.workers.dev"

            if [ "${{ steps.deploy-main.outcome }}" = "success" ]; then
              echo "âœ… ä¸»è¦éƒ¨ç½²æ–¹å¼æˆåŠŸ"
            else
              echo "âœ… å¤‡ç”¨éƒ¨ç½²æ–¹å¼æˆåŠŸ"
            fi

            # æµ‹è¯•éƒ¨ç½²çš„Worker
            echo "ğŸ§ª æµ‹è¯•éƒ¨ç½²çš„Worker..."
            sleep 10
            HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" https://destiny-backend.jerryliang5119.workers.dev/api/health || echo "000")
            echo "Health check response: $HEALTH_CHECK"

            if [ "$HEALTH_CHECK" = "200" ]; then
              echo "âœ… Workerå¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âš ï¸ Workerå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†éƒ¨ç½²å¯èƒ½ä»ç„¶æˆåŠŸ"
            fi
          else
            echo "âŒ åç«¯éƒ¨ç½²å¤±è´¥ï¼"
            echo ""
            echo "ğŸ” å¯èƒ½çš„åŸå› ï¼š"
            echo "1. API Tokenæƒé™ä¸è¶³ - éœ€è¦Workersã€Queuesã€D1ã€R2æƒé™"
            echo "2. æ–‡ä»¶å¤§å°é™åˆ¶ - worker.tsæ–‡ä»¶è¾ƒå¤§(5448è¡Œ)"
            echo "3. ç½‘ç»œè¶…æ—¶ - GitHub Actionsç¯å¢ƒç½‘ç»œé—®é¢˜"
            echo "4. Durable Objectsè¿ç§»å†²çª"
            echo "5. Cloudflareè´¦æˆ·é…é¢ä¸è¶³"
            echo ""
            echo "ğŸ› ï¸ å»ºè®®çš„ä¿®å¤æ–¹æ³•ï¼š"
            echo "1. æ£€æŸ¥GitHub Secretsé…ç½®"
            echo "2. æ‰‹åŠ¨éƒ¨ç½²: cd backend && wrangler deploy"
            echo "3. æ£€æŸ¥Cloudflare Dashboardä¸­çš„Workersé…é¢"
            echo "4. éªŒè¯API Tokenæƒé™èŒƒå›´"

            # ä¸è®©æ•´ä¸ªå·¥ä½œæµå¤±è´¥ï¼Œå…è®¸å‰ç«¯ç»§ç»­éƒ¨ç½²
            echo "âš ï¸ åç«¯éƒ¨ç½²å¤±è´¥ï¼Œä½†ä¸å½±å“å‰ç«¯éƒ¨ç½²"
          fi

      - name: Verify Deployment
        run: |
          echo "ğŸ§ª Verifying deployment..."
          sleep 15  # ç­‰å¾…éƒ¨ç½²å®Œå…¨ç”Ÿæ•ˆ

          # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
          echo "ğŸ“Š Testing health endpoint..."
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://destiny-backend.jerryliang5119.workers.dev/api/health)
          echo "Health response code: $HEALTH_RESPONSE"

          if [ "$HEALTH_RESPONSE" = "200" ]; then
            echo "âœ… Health check passed"
          else
            echo "âš ï¸ Health check returned: $HEALTH_RESPONSE"
          fi

          # æµ‹è¯•Stripeå¥åº·æ£€æŸ¥ç«¯ç‚¹
          echo "ğŸ“Š Testing Stripe health endpoint..."
          STRIPE_HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://destiny-backend.jerryliang5119.workers.dev/api/stripe/health)
          echo "Stripe health response code: $STRIPE_HEALTH_RESPONSE"

          if [ "$STRIPE_HEALTH_RESPONSE" = "200" ]; then
            echo "âœ… Stripe health check passed"
          else
            echo "âš ï¸ Stripe health check returned: $STRIPE_HEALTH_RESPONSE"
          fi

          echo "âœ… Deployment verification completed!"

      - name: Deployment Success
        run: |
          echo "ğŸ‰ Backend deployment completed successfully!"
          echo ""
          echo "ğŸ”— Backend URL: https://destiny-backend.jerryliang5119.workers.dev"
          echo "ğŸ”— Health Check: https://destiny-backend.jerryliang5119.workers.dev/api/health"
          echo "ğŸ”— Stripe Health: https://destiny-backend.jerryliang5119.workers.dev/api/stripe/health"
          echo ""
          echo "ğŸ“‹ Next steps:"
          echo "1. Configure Stripe environment variables if needed"
          echo "2. Test payment endpoints"
          echo "3. Monitor application logs with: wrangler tail"
