# .github/workflows/deploy-frontend.yml

name: Deploy Frontend to Cloudflare Pages

on:
  # å½“ä»£ç è¢«æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      # ç›‘æ§æ‰€æœ‰å‰ç«¯ç›¸å…³çš„æ–‡ä»¶å’Œç›®å½•
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'tsconfig.json'
      - '.env'
      - '.env.production'
      - '.github/workflows/deploy-frontend.yml'

  # å…è®¸æ‚¨åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # ç¼“å­˜npmä¾èµ–ï¼ŒåŠ å¿«åç»­æ„å»ºé€Ÿåº¦

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ Installing frontend dependencies..."
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed"

      - name: Build Frontend
        run: |
          echo "ğŸ”¨ Building frontend..."
          npm run build
          echo "ğŸ“Š Build output:"
          ls -la dist/
          echo "âœ… Frontend build completed"

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # æ³¨æ„è¿™é‡Œçš„å‘½ä»¤æ˜¯ pages deploy
          command: pages deploy dist --project-name=destiny-frontend --compatibility-date=2024-08-01

      - name: Verify Frontend Deployment
        run: |
          echo "ğŸ§ª Verifying frontend deployment..."
          sleep 10  # ç­‰å¾…éƒ¨ç½²å®Œå…¨ç”Ÿæ•ˆ

          # æµ‹è¯•ä¸»é¡µ
          echo "ğŸ“Š Testing main page..."
          MAIN_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://indicate.top)
          echo "Main page response code: $MAIN_RESPONSE"

          if [ "$MAIN_RESPONSE" = "200" ]; then
            echo "âœ… Main page accessible"
          else
            echo "âš ï¸ Main page returned: $MAIN_RESPONSE"
          fi

          echo "âœ… Frontend deployment verification completed!"

      - name: Frontend Deployment Success
        run: |
          echo "ğŸ‰ Frontend deployment completed successfully!"
          echo ""
          echo "ğŸ”— Frontend URL: https://indicate.top"
          echo "ğŸ”— Cloudflare Pages URL: https://destiny-frontend.pages.dev"
          echo ""
          echo "ğŸ“‹ Next steps:"
          echo "1. Test the application functionality"
          echo "2. Verify Stripe payment integration"
          echo "3. Check authentication flows"
