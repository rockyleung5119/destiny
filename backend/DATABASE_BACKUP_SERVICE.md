# Cloudflare D1æ•°æ®åº“è‡ªåŠ¨å¤‡ä»½æœåŠ¡

## ğŸ“‹ æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„Cloudflare D1æ•°æ®åº“è‡ªåŠ¨å¤‡ä»½è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒï¼š
- æ¯æ—¥è‡ªåŠ¨å¤‡ä»½ï¼ˆå‡Œæ™¨2ç‚¹UTCï¼‰
- æ‰‹åŠ¨å¤‡ä»½è§¦å‘
- å¤‡ä»½æ–‡ä»¶ç®¡ç†å’Œæ¸…ç†
- æ•°æ®åº“æ¢å¤åŠŸèƒ½
- å¤‡ä»½ç›‘æ§å’Œå¥åº·æ£€æŸ¥

## ğŸ—ï¸ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   D1 Database   â”‚â”€â”€â”€â–¶â”‚  Backup Service  â”‚â”€â”€â”€â–¶â”‚   R2 Storage    â”‚
â”‚   (destiny-db)  â”‚    â”‚  (Worker Cron)   â”‚    â”‚ (destiny-backups)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   API Endpoints  â”‚
                       â”‚  (Manual Control)â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è®¾ç½®æœåŠ¡
```bash
# è¿è¡Œè®¾ç½®è„šæœ¬
powershell -ExecutionPolicy Bypass -File setup-backup-service.ps1

# æˆ–è€…æ‰‹åŠ¨éƒ¨ç½²
wrangler deploy
```

### 2. éªŒè¯é…ç½®
```bash
# æ£€æŸ¥R2å­˜å‚¨æ¡¶
wrangler r2 bucket list

# æµ‹è¯•å¤‡ä»½æœåŠ¡
node monitor-backup-service.js
```

### 3. æ‰‹åŠ¨å¤‡ä»½æµ‹è¯•
```bash
# æ‰§è¡Œæ‰‹åŠ¨å¤‡ä»½
node monitor-backup-service.js --test-backup
```

## ğŸ“… è‡ªåŠ¨å¤‡ä»½è®¡åˆ’

- **é¢‘ç‡**: æ¯æ—¥ä¸€æ¬¡
- **æ—¶é—´**: å‡Œæ™¨2:00 AM UTC
- **ä¿ç•™æœŸ**: 30å¤©ï¼ˆè‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ï¼‰
- **å‹ç¼©**: gzipå‹ç¼©
- **å‘½å**: `destiny-db-backup-YYYY-MM-DDTHH-mm-ss-sssZ.sql`

## ğŸ”§ APIç«¯ç‚¹

### æ‰‹åŠ¨å¤‡ä»½
```http
POST /api/admin/backup-database
Content-Type: application/json

Response:
{
  "success": true,
  "message": "Database backup completed: destiny-db-backup-2024-08-20T02-00-00-000Z.sql",
  "backupInfo": {
    "fileName": "destiny-db-backup-2024-08-20T02-00-00-000Z.sql",
    "timestamp": "2024-08-20T02:00:00.000Z",
    "size": 1048576,
    "tables": ["users", "async_tasks", "verification_codes"],
    "success": true
  }
}
```

### è·å–å¤‡ä»½åˆ—è¡¨
```http
GET /api/admin/backups

Response:
{
  "success": true,
  "backups": [
    {
      "fileName": "destiny-db-backup-2024-08-20T02-00-00-000Z.sql",
      "size": 1048576,
      "uploaded": "2024-08-20T02:00:00.000Z",
      "etag": "abc123..."
    }
  ]
}
```

### æ¢å¤æ•°æ®åº“
```http
POST /api/admin/restore-database
Content-Type: application/json

{
  "backupFileName": "destiny-db-backup-2024-08-20T02-00-00-000Z.sql"
}

Response:
{
  "success": true,
  "message": "Database restored from destiny-db-backup-2024-08-20T02-00-00-000Z.sql"
}
```

## ğŸ› ï¸ ç®¡ç†å·¥å…·

### å¤‡ä»½ç›‘æ§
```bash
# æ£€æŸ¥å¤‡ä»½çŠ¶æ€
node monitor-backup-service.js

# åŒ…å«æ‰‹åŠ¨å¤‡ä»½æµ‹è¯•
node monitor-backup-service.js --test-backup
```

### æ•°æ®åº“æ¢å¤
```bash
# åˆ—å‡ºå¯ç”¨å¤‡ä»½
node restore-database.js --list-only

# æ¢å¤æœ€æ–°å¤‡ä»½
node restore-database.js --latest --force

# æ¢å¤æŒ‡å®šå¤‡ä»½
node restore-database.js "destiny-db-backup-2024-08-20T02-00-00-000Z.sql" --force
```

### æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶
```bash
# åˆ—å‡ºR2å­˜å‚¨ä¸­çš„å¤‡ä»½
wrangler r2 object list destiny-backups

# ä¸‹è½½å¤‡ä»½æ–‡ä»¶
wrangler r2 object get destiny-backups/destiny-db-backup-2024-08-20T02-00-00-000Z.sql --file backup.sql.gz
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
# æŸ¥çœ‹Workeræ—¥å¿—
wrangler tail --format pretty

# è¿‡æ»¤å¤‡ä»½ç›¸å…³æ—¥å¿—
wrangler tail --format pretty | grep -i backup
```

### å¤‡ä»½å¥åº·æ£€æŸ¥
ç›‘æ§è„šæœ¬ä¼šæ£€æŸ¥ï¼š
- âœ… æœ€è¿‘å¤‡ä»½æ—¶é—´ï¼ˆ25å°æ—¶å†…ï¼‰
- âœ… å¤‡ä»½å¤§å°ä¸€è‡´æ€§
- âœ… å¤‡ä»½é¢‘ç‡æ­£å¸¸
- âœ… ä¿ç•™æœŸç­–ç•¥æ‰§è¡Œ

## ğŸ” å®‰å…¨è€ƒè™‘

### è®¿é—®æ§åˆ¶
- å¤‡ä»½APIç«¯ç‚¹ä»…é™ç®¡ç†å‘˜è®¿é—®
- R2å­˜å‚¨æ¡¶è®¿é—®å—Cloudflareè´¦æˆ·æƒé™æ§åˆ¶
- å¤‡ä»½æ–‡ä»¶åŒ…å«æ•æ„Ÿæ•°æ®ï¼Œéœ€è°¨æ…å¤„ç†

### æ•°æ®ä¿æŠ¤
- å¤‡ä»½æ–‡ä»¶ä½¿ç”¨gzipå‹ç¼©
- è‡ªåŠ¨æ¸…ç†30å¤©ä»¥ä¸Šçš„æ—§å¤‡ä»½
- æ¢å¤å‰è‡ªåŠ¨åˆ›å»ºå®‰å…¨å¤‡ä»½

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. å¤‡ä»½å¤±è´¥ - R2å­˜å‚¨æ¡¶ä¸å­˜åœ¨**
```bash
# åˆ›å»ºR2å­˜å‚¨æ¡¶
wrangler r2 bucket create destiny-backups
```

**2. å¤‡ä»½å¤±è´¥ - æƒé™é—®é¢˜**
```bash
# æ£€æŸ¥wrangler.tomlé…ç½®
cat wrangler.toml | grep -A 3 "r2_buckets"
```

**3. å®šæ—¶å¤‡ä»½ä¸æ‰§è¡Œ**
```bash
# æ£€æŸ¥cronè§¦å‘å™¨é…ç½®
cat wrangler.toml | grep -A 2 "triggers"

# æŸ¥çœ‹Workeræ—¥å¿—
wrangler tail
```

**4. å¤‡ä»½æ–‡ä»¶æŸå**
```bash
# æµ‹è¯•å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
node monitor-backup-service.js --test-backup
```

### æ—¥å¿—åˆ†æ
```bash
# æŸ¥æ‰¾å¤‡ä»½ç›¸å…³é”™è¯¯
wrangler tail | grep -E "(backup|error|failed)"

# æŸ¥çœ‹å¤‡ä»½æˆåŠŸæ—¥å¿—
wrangler tail | grep "backup.*success"
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å¤‡ä»½ä¼˜åŒ–
- ä½¿ç”¨gzipå‹ç¼©å‡å°‘å­˜å‚¨ç©ºé—´
- åˆ†æ‰¹å¤„ç†å¤§å‹è¡¨æ•°æ®
- å¼‚æ­¥ä¸Šä¼ åˆ°R2å­˜å‚¨

### æ¢å¤ä¼˜åŒ–
- åˆ†æ‰¹æ‰§è¡ŒSQLè¯­å¥
- äº‹åŠ¡å¤„ç†ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- æ¢å¤å‰éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§

## ğŸ”„ å‡çº§å’Œç»´æŠ¤

### å®šæœŸç»´æŠ¤ä»»åŠ¡
1. **æ¯å‘¨**: æ£€æŸ¥å¤‡ä»½çŠ¶æ€å’Œå¥åº·åº¦
2. **æ¯æœˆ**: æµ‹è¯•æ•°æ®åº“æ¢å¤æµç¨‹
3. **æ¯å­£åº¦**: å®¡æŸ¥å¤‡ä»½ä¿ç•™ç­–ç•¥
4. **æ¯å¹´**: æ›´æ–°å¤‡ä»½å’Œæ¢å¤æ–‡æ¡£

### å‡çº§æ­¥éª¤
1. æµ‹è¯•æ–°ç‰ˆæœ¬çš„å¤‡ä»½æœåŠ¡
2. åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ¢å¤åŠŸèƒ½
3. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
4. éªŒè¯è‡ªåŠ¨å¤‡ä»½æ­£å¸¸è¿è¡Œ

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. æ£€æŸ¥Workeræ—¥å¿—ï¼š`wrangler tail`
3. è¿è¡Œç›‘æ§è„šæœ¬ï¼š`node monitor-backup-service.js`
4. æ£€æŸ¥R2å­˜å‚¨çŠ¶æ€ï¼š`wrangler r2 bucket list`

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-08-20)
- âœ… åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… æ¯æ—¥è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½
- âœ… æ‰‹åŠ¨å¤‡ä»½API
- âœ… æ•°æ®åº“æ¢å¤åŠŸèƒ½
- âœ… å¤‡ä»½ç›‘æ§å·¥å…·
- âœ… è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½
