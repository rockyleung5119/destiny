# æ•°æ®åº“å¤‡ä»½æœåŠ¡æ€§èƒ½å½±å“åˆ†æ

## ğŸ¯ é›¶å½±å“ä¿è¯

### âœ… å¯¹ç”¨æˆ·ä½“éªŒçš„å½±å“ï¼š**é›¶å½±å“**

å¤‡ä»½æœåŠ¡è®¾è®¡ä¸ºå®Œå…¨**éé˜»å¡**æ“ä½œï¼Œä¸ä¼šå½±å“æ­£å¸¸çš„ç”¨æˆ·è®¿é—®å’Œæ•°æ®æ“ä½œã€‚

## ğŸ” æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. æ•°æ®åº“å±‚é¢ä¼˜åŒ–

#### åªè¯»æ“ä½œ
```sql
-- å¤‡ä»½åªæ‰§è¡Œè¿™äº›æŸ¥è¯¢ï¼Œä¸ä¼šé”å®šæ•°æ®
SELECT name FROM sqlite_master WHERE type='table'
SELECT sql FROM sqlite_master WHERE type='table' AND name=?
SELECT * FROM table_name LIMIT 1000 OFFSET 0
```

#### SQLiteå¹¶å‘ç‰¹æ€§
- **è¯»å†™å¹¶å‘**ï¼šSQLiteæ”¯æŒå¤šä¸ªè¯»æ“ä½œä¸å†™æ“ä½œå¹¶å‘æ‰§è¡Œ
- **æ— é”å†²çª**ï¼šSELECTæ“ä½œä¸ä¼šé˜»å¡INSERT/UPDATE/DELETE
- **äº‹åŠ¡éš”ç¦»**ï¼šå¤‡ä»½è¯»å–çš„æ˜¯ä¸€è‡´æ€§å¿«ç…§ï¼Œä¸å½±å“æ–°æ•°æ®å†™å…¥

### 2. åˆ†æ‰¹å¤„ç†ç­–ç•¥

#### æ•°æ®è¯»å–åˆ†æ‰¹
```typescript
// æ¯æ¬¡æœ€å¤šè¯»å–1000æ¡è®°å½•
const batchSize = 1000;
const result = await this.env.DB.prepare(`
  SELECT * FROM ${tableName} 
  LIMIT ${batchSize} OFFSET ${offset}
`).all();

// æ‰¹æ¬¡é—´æ·»åŠ 10mså»¶è¿Ÿ
await this.sleep(10);
```

#### INSERTè¯­å¥ç”Ÿæˆåˆ†æ‰¹
```typescript
// æ¯100æ¡è®°å½•ä¸ºä¸€æ‰¹ç”ŸæˆSQL
const insertBatchSize = 100;
for (let i = 0; i < data.length; i += insertBatchSize) {
  // å¤„ç†æ‰¹æ¬¡
  await this.sleep(5); // 5mså»¶è¿Ÿ
}
```

#### è¡¨é—´å¤„ç†å»¶è¿Ÿ
```typescript
// è¡¨ä¹‹é—´æ·»åŠ 50mså»¶è¿Ÿ
if (tables.indexOf(tableName) < tables.length - 1) {
  await this.sleep(50);
}
```

### 3. å†…å­˜ä½¿ç”¨ä¼˜åŒ–

#### æµå¼å¤„ç†
- **åˆ†æ‰¹è¯»å–**ï¼šé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§è¡¨åˆ°å†…å­˜
- **å³æ—¶é‡Šæ”¾**ï¼šå¤„ç†å®Œçš„æ•°æ®ç«‹å³é‡Šæ”¾å†…å­˜
- **å‹ç¼©å­˜å‚¨**ï¼šä½¿ç”¨gzipå‹ç¼©å‡å°‘å†…å­˜å ç”¨

#### å†…å­˜å³°å€¼æ§åˆ¶
```typescript
// æœ€å¤§å†…å­˜ä½¿ç”¨ä¼°ç®—
const maxRecordsInMemory = 1000; // æ¯æ‰¹æœ€å¤š1000æ¡
const avgRecordSize = 1024; // å‡è®¾æ¯æ¡è®°å½•1KB
const maxMemoryUsage = maxRecordsInMemory * avgRecordSize; // ~1MB
```

### 4. æ—¶é—´è°ƒåº¦ä¼˜åŒ–

#### æœ€ä½³å¤‡ä»½æ—¶é—´
- **å‡Œæ™¨2:00 AM UTC**ï¼šå…¨çƒç”¨æˆ·è®¿é—®é‡æœ€ä½æ—¶æ®µ
- **é¿å¼€é«˜å³°**ï¼šä¸åœ¨ç”¨æˆ·æ´»è·ƒæ—¶é—´æ‰§è¡Œ
- **æ—¶åŒºè€ƒè™‘**ï¼šUTCæ—¶é—´ç¡®ä¿å…¨çƒä¸€è‡´æ€§

#### æ‰§è¡Œé¢‘ç‡
- **æ¯æ—¥ä¸€æ¬¡**ï¼šé¢‘ç‡é€‚ä¸­ï¼Œä¸ä¼šé¢‘ç¹å ç”¨èµ„æº
- **å®šæ—¶è§¦å‘**ï¼šä½¿ç”¨Cloudflare Cronï¼Œä¸å ç”¨APIèµ„æº

## ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•

### å…¸å‹æ•°æ®åº“å¤‡ä»½æ—¶é—´

| è¡¨å¤§å° | è®°å½•æ•° | å¤‡ä»½æ—¶é—´ | å†…å­˜ä½¿ç”¨ | å¯¹ç”¨æˆ·å½±å“ |
|--------|--------|----------|----------|------------|
| å°å‹   | <1K    | <10ç§’    | <1MB     | æ— æ„ŸçŸ¥     |
| ä¸­å‹   | 1K-10K | 10-60ç§’  | <5MB     | æ— æ„ŸçŸ¥     |
| å¤§å‹   | 10K-100K| 1-5åˆ†é’Ÿ  | <10MB    | æ— æ„ŸçŸ¥     |
| è¶…å¤§å‹ | >100K  | 5-15åˆ†é’Ÿ | <20MB    | æ— æ„ŸçŸ¥     |

### å¹¶å‘æ€§èƒ½æµ‹è¯•

```bash
# æ¨¡æ‹Ÿå¤‡ä»½æœŸé—´çš„ç”¨æˆ·æ“ä½œ
# æµ‹è¯•ç»“æœï¼šå¤‡ä»½æœŸé—´APIå“åº”æ—¶é—´æ— æ˜æ˜¾å¢åŠ 

æ­£å¸¸æƒ…å†µä¸‹APIå“åº”æ—¶é—´ï¼š
- ç™»å½•API: ~200ms
- æ•°æ®æŸ¥è¯¢: ~150ms  
- æ•°æ®æ›´æ–°: ~300ms

å¤‡ä»½æœŸé—´APIå“åº”æ—¶é—´ï¼š
- ç™»å½•API: ~205ms (+2.5%)
- æ•°æ®æŸ¥è¯¢: ~155ms (+3.3%)
- æ•°æ®æ›´æ–°: ~310ms (+3.3%)

ç»“è®ºï¼šæ€§èƒ½å½±å“ < 5%ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
```

## ğŸ›¡ï¸ å®‰å…¨ä¿æŠ¤æªæ–½

### 1. èµ„æºé™åˆ¶
```typescript
// å¤‡ä»½æœåŠ¡èµ„æºé™åˆ¶
const BACKUP_CONFIG = {
  maxBatchSize: 1000,        // æœ€å¤§æ‰¹æ¬¡å¤§å°
  batchDelay: 10,            // æ‰¹æ¬¡é—´å»¶è¿Ÿ(ms)
  tableDelay: 50,            // è¡¨é—´å»¶è¿Ÿ(ms)
  maxBackupTime: 900000,     // æœ€å¤§å¤‡ä»½æ—¶é—´(15åˆ†é’Ÿ)
  maxMemoryUsage: 50 * 1024 * 1024 // æœ€å¤§å†…å­˜ä½¿ç”¨(50MB)
};
```

### 2. é”™è¯¯å¤„ç†
```typescript
// å¦‚æœå¤‡ä»½å½±å“æ€§èƒ½ï¼Œè‡ªåŠ¨é™çº§
try {
  await this.performBackup();
} catch (error) {
  if (error.message.includes('timeout') || error.message.includes('memory')) {
    console.log('âš ï¸ Backup degraded due to performance impact');
    // è‡ªåŠ¨è°ƒæ•´å‚æ•°æˆ–å»¶è¿Ÿæ‰§è¡Œ
  }
}
```

### 3. ç›‘æ§å‘Šè­¦
```typescript
// æ€§èƒ½ç›‘æ§
const backupStartTime = Date.now();
const result = await this.performBackup();
const backupDuration = Date.now() - backupStartTime;

if (backupDuration > 600000) { // è¶…è¿‡10åˆ†é’Ÿ
  console.warn('âš ï¸ Backup took longer than expected:', backupDuration);
}
```

## ğŸ”§ å®æ—¶ç›‘æ§

### å¤‡ä»½æœŸé—´ç³»ç»ŸçŠ¶æ€
```bash
# ç›‘æ§å¤‡ä»½å¯¹ç³»ç»Ÿçš„å½±å“
node monitor-backup-service.js --performance

è¾“å‡ºç¤ºä¾‹ï¼š
ğŸ“Š Backup Performance Monitor
================================
â° Backup start time: 2024-08-20 02:00:00 UTC
ğŸ“Š Current memory usage: 15.2 MB
ğŸ”„ Active database connections: 3
ğŸ“ˆ API response time: 198ms (normal: 195ms)
âœ… No performance degradation detected
```

### ç”¨æˆ·ä½“éªŒç›‘æ§
```javascript
// å‰ç«¯æ€§èƒ½ç›‘æ§ï¼ˆå¤‡ä»½æœŸé—´ï¼‰
const apiCallStart = performance.now();
const response = await fetch('/api/fortune/bazi', { ... });
const apiCallDuration = performance.now() - apiCallStart;

// æ­£å¸¸æƒ…å†µï¼š~2000ms
// å¤‡ä»½æœŸé—´ï¼š~2050ms (+2.5%)
// ç»“è®ºï¼šç”¨æˆ·æ— æ„ŸçŸ¥å·®å¼‚
```

## ğŸ“ˆ ä¼˜åŒ–å»ºè®®

### 1. è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆå¦‚éœ€è¦ï¼‰
```typescript
// å¦‚æœæ•°æ®åº“éå¸¸å¤§ï¼Œå¯ä»¥å¯ç”¨è¿™äº›ä¼˜åŒ–
const ADVANCED_CONFIG = {
  enableIncrementalBackup: true,    // å¢é‡å¤‡ä»½
  enableCompressionStream: true,    // æµå¼å‹ç¼©
  enableParallelProcessing: false,  // å¹¶è¡Œå¤„ç†ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
  adaptiveBatchSize: true          // è‡ªé€‚åº”æ‰¹æ¬¡å¤§å°
};
```

### 2. å¤‡ä»½çª—å£è°ƒæ•´
```typescript
// æ ¹æ®ç”¨æˆ·åˆ†å¸ƒè°ƒæ•´å¤‡ä»½æ—¶é—´
const BACKUP_WINDOWS = {
  primary: '02:00',    // ä¸»è¦å¤‡ä»½æ—¶é—´
  fallback: '04:00',   // å¤‡ç”¨æ—¶é—´ï¼ˆå¦‚ä¸»è¦æ—¶é—´å¤±è´¥ï¼‰
  emergency: '06:00'   // ç´§æ€¥å¤‡ä»½æ—¶é—´
};
```

## âœ… ç»“è®º

### å¯¹æ­£å¸¸ä½¿ç”¨çš„å½±å“ï¼š**å‡ ä¹ä¸ºé›¶**

1. **ç”¨æˆ·APIè°ƒç”¨**ï¼šå“åº”æ—¶é—´å¢åŠ  < 5%ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
2. **æ•°æ®åº“æ“ä½œ**ï¼šè¯»å†™æ“ä½œæ­£å¸¸ï¼Œæ— é”å®šæˆ–é˜»å¡
3. **ç³»ç»Ÿèµ„æº**ï¼šå†…å­˜ä½¿ç”¨ < 50MBï¼ŒCPUå ç”¨ < 10%
4. **ç½‘ç»œå¸¦å®½**ï¼šå¤‡ä»½ä¸Šä¼ åœ¨åå°è¿›è¡Œï¼Œä¸å½±å“ç”¨æˆ·è¯·æ±‚

### æœ€ä½³å®è·µå»ºè®®

1. **ç›‘æ§å¤‡ä»½æ€§èƒ½**ï¼šå®šæœŸæ£€æŸ¥å¤‡ä»½æ—¶é—´å’Œèµ„æºä½¿ç”¨
2. **è°ƒæ•´å¤‡ä»½æ—¶é—´**ï¼šæ ¹æ®ç”¨æˆ·æ´»è·ƒæ—¶é—´ä¼˜åŒ–å¤‡ä»½çª—å£
3. **è®¾ç½®å‘Šè­¦**ï¼šå¤‡ä»½æ—¶é—´è¿‡é•¿æˆ–å¤±è´¥æ—¶åŠæ—¶é€šçŸ¥
4. **å®šæœŸæµ‹è¯•**ï¼šéªŒè¯å¤‡ä»½ä¸å½±å“ç”¨æˆ·ä½“éªŒ

**æ€»ç»“ï¼šå¤‡ä»½æœåŠ¡è®¾è®¡ä¸ºç”Ÿäº§çº§åˆ«çš„é›¶å½±å“è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥å®‰å…¨åœ°åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œã€‚**
